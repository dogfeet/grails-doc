<html>
     <head>
     	<meta http-equiv="Content-type" content="text/html; charset=utf-8">
     	<title>14.3 Runtime Spring with the Beans DSL</title>
     	<link rel="stylesheet" href="../css/main.css" type="text/css" media="screen" title="Ref" charset="utf-8">
     </head>
	<body class="body">
		Spring은 매우 강력하지만 XML 기반 문법은 번거롭고 다양한 수준에서 최근에 Spring 2.0에서 추가된 것들 조차 DRY를 위반한다. Grails의 BeanBuider는 Spring과 그 Core를 사용하여 의존성을 서로 연결하는 간단한 방법을 제공하는 것을 목표로 하고 있다.<p class="paragraph"/>더불어 Spring의 (XML을 통해) 설정하는 방식은 반드시 정적으로 해야 하고, 런타임에 수정하고 설정하기 매우 힘들 뿐 아니라, 프로그램으로 XML을 생성하는 것보다 자주 오류를 발생시키고 틀리기 쉽다. Grails <a href="../api/grails/spring/BeanBuilder.html" class="api">BeanBuilder</a>는 런타임에 컴포넌트들을 서로 함께 프로그램적으로 연결하는것을 가능하게 함으로써 모든 것을 바꾼다. 그래서 시스템 프로퍼티나 환경 변수에 따라 로직을 적응할 수 있도록 할 수 있다.<p class="paragraph"/>이것은 코드가 자신이 속한 환경에 적응할 수 있도록 하며 불필요한 코드의 중복(테스트, 개발, 실제품환경에 대한 서로다른 Spring 설정을 갖는것)을 줄여준다.<p class="paragraph"/><h4>The BeanBuilder class(BeanBuilder 클래스)</h4><p class="paragraph"/>Grails는 <a href="../api/grails/spring/BeanBuilder.html" class="api">grails.spring.BeanBuilder</a> 클래스를 제공하며 Bean 정의들을 만들기위해 동적 Groovy를 사용한다. 기본 코드는 다음과 같다:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> org.apache.commons.dbcp.BasicDataSource
<span class="java&#45;keyword">import</span> org.codehaus.groovy.grails.orm.hibernate.ConfigurableLocalSessionFactoryBean;
<span class="java&#45;keyword">import</span> org.springframework.context.ApplicationContext;<p class="paragraph"/>def bb = <span class="java&#45;keyword">new</span> grails.spring.BeanBuilder()<p class="paragraph"/>bb.beans &#123;
	dataSource(BasicDataSource) &#123;
		driverClassName = <span class="java&#45;quote">"org.hsqldb.jdbcDriver"</span>
		url = <span class="java&#45;quote">"jdbc:hsqldb:mem:grailsDB"</span>
		username = <span class="java&#45;quote">"sa"</span>
		password = <span class="java&#45;quote">""</span>
	&#125;
        sessionFactory(ConfigurableLocalSessionFactoryBean) &#123;
              dataSource = dataSource
              hibernateProperties = &#91; <span class="java&#45;quote">"hibernate.hbm2ddl.auto"</span>:<span class="java&#45;quote">"create&#45;drop"</span>,
                                      <span class="java&#45;quote">"hibernate.show_sql"</span>:<span class="java&#45;keyword">true</span>  &#93;
        &#125;<p class="paragraph"/>&#125;<p class="paragraph"/>ApplicationContext appContext = bb.createApplicationContext()</pre></div><p class="paragraph"/><blockquote class="note">
plug-ins나 <a href="../guide/single.html#14.2 Configuring Additional Beans" class="guide">grails-app/conf/spring/resources.groovy</a> 파일에서 새로운 BeanBuider 인스턴스를 새로 만들 필요는 없다. 그 대신 DSL은 묵시적으로 doWithSpring 안에서나 각 beans block에서 사용가능하다.
</blockquote><p class="paragraph"/>위의 예제는 BeanBuider 클래스를 이용하여 어떻게 Hibernate를 적절한 dataSource와 설정을 할 수 있는지를 보여준다.<p class="paragraph"/>각 메소드 호출(이번 경우는 dataSource나 sessionFactory의 호출)은 필히 Spring에서 Bean의 이름에 매핑된다. 메소드에 대한 첫 번째 인자는 Bean의 클래스이며 마지막 인자는 코드 블럭이다. 블럭의 본체에서 표준 Groovy 문법을 이용하여 Bean의 프로퍼티를 정할 수 있다.<p class="paragraph"/>Bean 참조문제는 Bean의 이름을 이용하여 자동적으로 풀어간다. 이것은 위의 예제에서 sessionFactory Bean이 dataSource 참조를 풀어가는 방식을 통해살펴 볼 수 있다.<p class="paragraph"/>Bean 관리에 관계된 일정한 특정 프로퍼티는 아래의 코드에서 볼 수 있듯이 빌더에의해 정해질 수 있다:<p class="paragraph"/><div class="code"><pre>sessionFactory(ConfigurableLocalSessionFactoryBean) &#123; bean &#45;&#62;
    bean.autowire = 'byName'       // Autowiring behaviour. The other option is 'byType'. &#91;autowire&#93;
    bean.initMethod = 'init'       // Sets the initialisation method to 'init'. &#91;init&#45;method&#93;
    bean.destroyMethod = 'destroy' // Sets the destruction method to 'destroy'. &#91;destroy&#45;method&#93;
    dataSource = dataSource
    hibernateProperties = &#91; <span class="java&#45;quote">"hibernate.hbm2ddl.auto"</span>:<span class="java&#45;quote">"create&#45;drop"</span>,
                            <span class="java&#45;quote">"hibernate.show_sql"</span>:<span class="java&#45;keyword">true</span>  &#93;
&#125;</pre></div><p class="paragraph"/>'', '' 안의 문자열은 Spring의 XML 정의 안에서의 Bean 속성(Attribute)과 동일한 이름들이다.<p class="paragraph"/><h4>Using Constructor Arguments(생성자 인자 사용)</h4><p class="paragraph"/>생성자의 인자는 각 메소드의 파라미터를 통해서 정의할 수 있고 Bean의 클래스와 마지막 클로져 사이에 위치한다:<p class="paragraph"/><div class="code"><pre>bb.beans &#123;
   exampleBean(MyExampleBean, <span class="java&#45;quote">"firstArgument"</span>, 2) &#123;
       someProperty = &#91;1,2,3&#93;
   &#125;
&#125;</pre></div><p class="paragraph"/><h4>Configuring the BeanDefinition (Using factory methods) (BeanDefinition을 설정(팩토리 메소드 사용하여))</h4><p class="paragraph"/>클로져의 첫 번째 인자는 Bean 설정 인스턴스의 한 참조이며 팩토리 메소드를 통해 설정하곤 하고 <a href="http://static.springframework.org/spring/docs/2.5.x/api/org/springframework/beans/factory/support/AbstractBeanDefinition.html" class="api">AbstractBeanDefinition</a> 클래스상에서는 어떤 메소드도 실행할 수 있다:<p class="paragraph"/><div class="code"><pre>bb.beans &#123;
   exampleBean(MyExampleBean) &#123; bean &#45;&#62;
       bean.factoryMethod = <span class="java&#45;quote">"getInstance"</span>
       bean.singleton = <span class="java&#45;keyword">false</span>
       someProperty = &#91;1,2,3&#93;
   &#125;
&#125;</pre></div><p class="paragraph"/>다른 대안으로서 Bean을 설정하기 위해 정의하는 메소드의 리턴 값을 이용할 수도 있다:<p class="paragraph"/><div class="code"><pre>bb.beans &#123;
   def example = exampleBean(MyExampleBean) &#123;
       someProperty = &#91;1,2,3&#93;
   &#125;
   example.factoryMethod = <span class="java&#45;quote">"getInstance"</span>
&#125;</pre></div><p class="paragraph"/><h4>Using Factory beans(Factory Bean을 이용)</h4><p class="paragraph"/>Spring은 Factory Bean이라는 개념을 정의한다. 그리고 종종 Bean은 클래스로부터 만들어지지 않고 이런 Factory들로부터 만들어진다. 이런 경우 Bean은 어떠한 클래스도 가지지 않으며 대신 Bean으로 Factory Bean의 이름을 넘겨줘야 한다:<p class="paragraph"/><div class="code"><pre>bb.beans &#123;
   myFactory(ExampleFactoryBean) &#123;
       someProperty = &#91;1,2,3&#93;
   &#125;
   myBean(myFactory) &#123;
        name = <span class="java&#45;quote">"blah"</span>
   &#125;
&#125;</pre></div><p class="paragraph"/>이 예제를 살펴보면 클래스 대신 myFactory Bean에 대한 참조를 메소드를 정의하는 Bean으로 넘긴다. 또 다른 것은 Factory Bean에서 호출되도록 Factory 메소드의 이름을 제공하는 것이다. 이것은 Groovy의 네임드 파라미터 문법을 이용하여 한다:<p class="paragraph"/><div class="code"><pre>bb.beans &#123;
   myFactory(ExampleFactoryBean) &#123;
       someProperty = &#91;1,2,3&#93;
   &#125;
   myBean(myFactory:<span class="java&#45;quote">"getInstance"</span>) &#123;
        name = <span class="java&#45;quote">"blah"</span>
   &#125;
&#125;</pre></div><p class="paragraph"/>myBean을 만들기 위해 ExampleFactoryBean의 getInstance메소드를 호출한다.<p class="paragraph"/><h4>Creating Bean References at Runtime(런타임에 Bean 참조를 만들기)</h4><p class="paragraph"/>때때로 런타임에나 만들어야 할 Bean의 이름을 알게 될 수도 있다. 이런 경우 동적으로 Bean이 정의하는 메소드를 실행하려면 문자열 interpolation을 사용할 수 있다:<p class="paragraph"/><div class="code"><pre>def beanName = <span class="java&#45;quote">"example"</span>
bb.beans &#123;
   <span class="java&#45;quote">"$&#123;beanName&#125;Bean"</span>(MyExampleBean) &#123;
       someProperty = &#91;1,2,3&#93;
   &#125;
&#125;</pre></div><p class="paragraph"/>이 경우 앞에서 정의된 beanName 변수를 이용하여 Bean 정의 메소드를 실행할 때 사용한다.<p class="paragraph"/>게다가 Bean의 이름을 런타임까지 알 수 없기 때문에 다른 Bean들과 함께 사용하려면 그것들을 참조할 필요가 있다. 이럴 경우 ref 메소드를 사용한다:<p class="paragraph"/><div class="code"><pre>def beanName = <span class="java&#45;quote">"example"</span>
bb.beans &#123;
   <span class="java&#45;quote">"$&#123;beanName&#125;Bean"</span>(MyExampleBean) &#123;
       someProperty = &#91;1,2,3&#93;
   &#125;
   anotherBean(AnotherBean) &#123;
       example = ref(<span class="java&#45;quote">"$&#123;beanName&#125;Bean"</span>)
   &#125;
&#125;</pre></div><p class="paragraph"/>
AnotherBean의 example 프로퍼티는 exampleBean에 대한 런타임 참조를 사용해 정해진다. ref 메소드는 또한 BeanBuider의 생성자에서 제공된 부모 ApplicationContext로부터의 Bean들을 참조하기 위해서도 사용한다:<p class="paragraph"/><div class="code"><pre>ApplicationContext parent = ...//
der bb = <span class="java&#45;keyword">new</span> BeanBuilder(parent)
bb.beans &#123;
   anotherBean(AnotherBean) &#123;
       example = ref(<span class="java&#45;quote">"$&#123;beanName&#125;Bean"</span>, <span class="java&#45;keyword">true</span>)
   &#125;
&#125;</pre></div><p class="paragraph"/>두번째 파라미터 true는 참조가 parent context에서 Bean을 찾도록 지정한다.<p class="paragraph"/><h4>Using Anonymous (Inner) Beans(익명(내부) Bean 이용)</h4><p class="paragraph"/>Bean의 한 프로퍼티를 Bean 타입으로 인자를 받을 수 있는 코드로 설정해서 익명 내부 Bean을 이용할 수 있다:<p class="paragraph"/><div class="code"><pre>bb.beans &#123;
  marge(Person.class) &#123;
      name = <span class="java&#45;quote">"marge"</span>
      husband =  &#123; Person p &#45;&#62;
 	              name = <span class="java&#45;quote">"homer"</span>
		      age = 45
                      props = &#91;overweight:<span class="java&#45;keyword">true</span>, height:<span class="java&#45;quote">"1.8m"</span>&#93; &#125;
      children = &#91;bart, lisa&#93;
  &#125;
  bart(Person) &#123;
      name = <span class="java&#45;quote">"Bart"</span>
      age = 11
  &#125;
  lisa(Person) &#123;
      name = <span class="java&#45;quote">"Lisa"</span>
      age = 9
  &#125;
&#125;</pre></div><p class="paragraph"/>위의 예제에서 marge Bean의 husband 프로퍼티를 내부 Bean 참조를 생성하는 코드로 정하였다. 또한 Factory Bean을 가지고 있다면 타입을 생략하고 Factory를 설정하는 대신에 넘겨받은 Bean 정의를 사용할 수 있다:<p class="paragraph"/><div class="code"><pre>bb.beans &#123;
  personFactory(PersonFactory.class)
  marge(Person.class) &#123;
      name = <span class="java&#45;quote">"marge"</span>
      husband =  &#123; bean &#45;&#62;
                     bean.factoryBean = <span class="java&#45;quote">"personFactory"</span>
                     bean.factoryMethod = <span class="java&#45;quote">"newInstance"</span>
 	              name = <span class="java&#45;quote">"homer"</span>
		      age = 45
                      props = &#91;overweight:<span class="java&#45;keyword">true</span>, height:<span class="java&#45;quote">"1.8m"</span>&#93; &#125;
      children = &#91;bart, lisa&#93;
  &#125;
&#125;</pre></div><p class="paragraph"/><h4>Abstract Beans and Parent Bean Definitions(추상 Bean과 부모 Bean 정의)</h4><p class="paragraph"/>추상 Bean 정의를 만들기위해서 아무 클래스도 받지 않는 클래스를 정의한다:<p class="paragraph"/><div class="code"><pre>class HolyGrailQuest &#123;
	   def start() &#123; println <span class="java&#45;quote">"lets begin"</span> &#125;
&#125;
class KnightOfTheRoundTable &#123;
   <span class="java&#45;object">String</span> name
   <span class="java&#45;object">String</span> leader
   KnightOfTheRoundTable(<span class="java&#45;object">String</span> n) &#123;
      <span class="java&#45;keyword">this</span>.name = n
   &#125;
   HolyGrailQuest quest<p class="paragraph"/>   def embarkOnQuest() &#123;
       quest.start()
   &#125;
&#125;<p class="paragraph"/>def bb = <span class="java&#45;keyword">new</span> grails.spring.BeanBuilder()
bb.beans &#123;
  abstractBean &#123;
      leader = <span class="java&#45;quote">"Lancelot"</span>
  &#125;
  &#8230;
&#125;</pre></div><p class="paragraph"/>leader 프로퍼티가 “Lancelot”값을 갖도록 하는 추상 Bean을 정의하였다. 이 추상 Bean을 이용하기 위해서 자식 Bean의 부모로 Bean을 정한다:<p class="paragraph"/><div class="code"><pre>bb.beans &#123;
  &#8230;
  quest(HolyGrailQuest)
  knights(KnightOfTheRoundTable, <span class="java&#45;quote">"Camelot"</span>) &#123; bean &#45;&#62;
      bean.parent = abstractBean
      quest = quest
  &#125;
&#125;</pre></div><p class="paragraph"/><blockquote class="note">
부모 Bean을 쓸 때 Bean의 다른 프로퍼티를 정하기전에 parent 프로퍼티를 먼저 정해야한다.
</blockquote><p class="paragraph"/>어떤 추상 Bean이 클래스를 가지도록 하려면 다음과 같이 할 수 있다.<p class="paragraph"/><div class="code"><pre>def bb = <span class="java&#45;keyword">new</span> grails.spring.BeanBuilder()
bb.beans &#123;                                          
  abstractBean(KnightOfTheRoundTable) &#123; bean &#45;&#62;
      bean.'<span class="java&#45;keyword">abstract</span>' = <span class="java&#45;keyword">true</span>                  
      leader = <span class="java&#45;quote">"Lancelot"</span>
  &#125;
  quest(HolyGrailQuest)
  knights(<span class="java&#45;quote">"Camelot"</span>) &#123; bean &#45;&#62;
      bean.parent = abstractBean
      quest = quest
  &#125;
&#125;</pre></div><p class="paragraph"/>위의 예제에서 KnightOfTheroundTable이라는 타입의 추상 Bean을 만들고 Bean의 인자를 추상화하는데 사용했다. 그리고 나서 knights Bean을 클래스 없이 정의하고 부모 Bean에서 클래스를 상속한다.<p class="paragraph"/><h4>Adding Variables to the Binding (Context) ((Context) 바인딩에 변수를 더하기)</h4><p class="paragraph"/>스크립트로부터 Bean을 로드하고 있다면 Groovy 바인딩 객체를 생성함으로써 사용할 바인딩을 설정할 수 있다:<p class="paragraph"/><div class="code"><pre>def bb = <span class="java&#45;keyword">new</span> BeanBuilder(<span class="java&#45;quote">"classpath:&#42;SpringBeans.groovy"</span>)
def binding = <span class="java&#45;keyword">new</span> Binding()
binding.foo = <span class="java&#45;quote">"bar"</span><p class="paragraph"/>bb.binding = binding<p class="paragraph"/>def ctx = bb.createApplicationContext()</pre></div><p class="paragraph"/><h4>Loading Bean Definitions from the File System(파일시스템으로부터 Bean 정의를 불러오기)</h4><p class="paragraph"/>외부의 Groovy 스크립트를 불러오기위해 BeanBuilder 클래스를 사용할 수 있다. Groovy 스크립트는 아래와 같이 경로 매칭 문법을 사용하여 Bean을 정의하고 있다:<p class="paragraph"/><div class="code"><pre>def bb = <span class="java&#45;keyword">new</span> BeanBuilder(<span class="java&#45;quote">"classpath:&#42;SpringBeans.groovy"</span>)<p class="paragraph"/>def applicationContext = bb.createApplicationContext()</pre></div><p class="paragraph"/>BeanBuilder는 SpringBeans.groovy로 끝나는 클래스 경로에서 Groovy 파일들을 불러올 것이며 그 파일들을 Bean 정의로 파싱한다. 그 예제가 아래와 같다:<p class="paragraph"/><div class="code"><pre>beans = &#123;
	dataSource(BasicDataSource) &#123;
		driverClassName = <span class="java&#45;quote">"org.hsqldb.jdbcDriver"</span>
		url = <span class="java&#45;quote">"jdbc:hsqldb:mem:grailsDB"</span>
		username = <span class="java&#45;quote">"sa"</span>
		password = <span class="java&#45;quote">""</span>
	&#125;
        sessionFactory(ConfigurableLocalSessionFactoryBean) &#123;
              dataSource = dataSource
              hibernateProperties = &#91; <span class="java&#45;quote">"hibernate.hbm2ddl.auto"</span>:<span class="java&#45;quote">"create&#45;drop"</span>,
                                      <span class="java&#45;quote">"hibernate.show_sql"</span>:<span class="java&#45;keyword">true</span>  &#93;
        &#125;<p class="paragraph"/>&#125;</pre></div><p class="paragraph"/>
	</body>
</html>